
(function(window){if(!Object.defineProperty){throw("Font.js requires Object.defineProperty, which this browser does not support.");}
if(!document.createElement("canvas").getContext){throw("Font.js requires <canvas> and the Canvas2D API, which this browser does not support.");}
(function(window){try{var a=new Uint8Array(1);return;}catch(e){}
function subarray(start,end){return this.slice(start,end);}
function set_(array,offset){var i,n=array.length;if(arguments.length<2){offset=0;}
for(i=0;i<n;++i,++offset){this[offset]=array[i]&0xFF;}}
function TypedArray(arg1){var result,i;if(typeof arg1==="number"){result=new Array(arg1);for(i=0;i<arg1;++i){result[i]=0;}}else{result=arg1.slice(0);}
result.subarray=subarray;result.buffer=result;result.byteLength=result.length;result.set=set_;if(typeof arg1==="object"&&arg1.buffer){result.buffer=arg1.buffer;}
return result;}
window.Uint8Array=TypedArray;window.Uint32Array=TypedArray;window.Int32Array=TypedArray;}(window));(function(window){if(window.opera)return;if("response"in XMLHttpRequest.prototype||"mozResponseArrayBuffer"in XMLHttpRequest.prototype||"mozResponse"in XMLHttpRequest.prototype||"responseArrayBuffer"in XMLHttpRequest.prototype){return;}
var getter;if(window.VBArray){getter=function(){return new Uint8Array(new VBArray(this.responseBody).toArray());}}
else{getter=function(){this.responseBody;}}
Object.defineProperty(XMLHttpRequest.prototype,"response",{get:getter});}(window));if(!window.btoa){window.btoa=function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc="",tmp_arr=[];if(!data){return data;}
do{o1=data.charCodeAt(i++);o2=data.charCodeAt(i++);o3=data.charCodeAt(i++);bits=o1<<16|o2<<8|o3;h1=bits>>18&0x3f;h2=bits>>12&0x3f;h3=bits>>6&0x3f;h4=bits&0x3f;tmp_arr[ac++]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4);}while(i<data.length);enc=tmp_arr.join('');var r=data.length%3;return(r?enc.slice(0,r-3):enc)+'==='.slice(r||3);};}
function Font(){this.fontFamily="fjs"+(999999*Math.random()|0);}
Font.prototype.url="";Font.prototype.format="";Font.prototype.data="";Font.prototype.base64="AAEAAAAKAIAAAwAgT1MvMgAAAAAAAACsAAAAWGNtYXAA"+"AAAAAAABBAAAACxnbHlmAAAAAAAAATAAAAAQaGVhZAAAA"+"AAAAAFAAAAAOGhoZWEAAAAAAAABeAAAACRobXR4AAAAAA"+"AAAZwAAAAIbG9jYQAAAAAAAAGkAAAACG1heHAAAAAAAAA"+"BrAAAACBuYW1lAAAAAAAAAcwAAAAgcG9zdAAAAAAAAAHs"+"AAAAEAAEAAEAZAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAABAAMAAQA"+"AAAwABAAgAAAABAAEAAEAAABB//8AAABB////wAABAAAA"+"AAABAAAAAAAAAAAAAAAAMQAAAQAAAAAAAAAAAABfDzz1A"+"AAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAEAAg"+"AAAAAAAAABAAAAAQAAAAEAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAQAAAAAAAAAAAAAAAAAIAAAAAQAAAAIAAQAB"+"AAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAIAHgADAAEEC"+"QABAAAAAAADAAEECQACAAIAAAAAAAEAAAAAAAAAAAAAAA"+"AAAA==";Font.prototype.metrics={quadsize:0,leading:0,ascent:0,descent:0,weightclass:400};Font.prototype.systemfont=false;Font.prototype.loaded=false;Font.prototype.onload=function(){};Font.prototype.onerror=function(){};Font.prototype.canvas=false;Font.prototype.context=false;Font.prototype.validate=function(target,zero,mark,font,timeout){if(timeout!==false&&timeout<0){this.onerror("Requested system font '"+this.fontFamily+"' could not be loaded (it may not be installed).");return;}
var width=getComputedStyle(target,null).getPropertyValue("width").replace("px",'');if(width>0){document.head.removeChild(zero);document.body.removeChild(target);this.loaded=true;this.onload();}
else{console.log("timing out");setTimeout(function(){font.validate(target,zero,mark,font,timeout===false?false:timeout-50);},1000);}};Font.prototype.ondownloaded=function(){var instance=this;var chr=function(val){return String.fromCharCode(val);};var chr16=function(val){if(val<256){return chr(0)+chr(val);}
var b1=val>>8;var b2=val&0xFF;return chr(b1)+chr(b2);};var dechex=function(val){if(val<0){val=0xFFFFFFFF+val+1;}
return parseInt(val,10).toString(16);};var ushort=function(b1,b2){return 256*b1+b2;};var fword=function(b1,b2){var negative=b1>>7===1,val;b1=b1&0x7F;val=256*b1+b2;if(!negative){return val;}
return val-0x8000;};var ulong=function(b1,b2,b3,b4){return 16777216*b1+65536*b2+256*b3+b4;};var error=function(msg){instance.onerror(msg);};var ttf=chr(0)+chr(1)+chr(0)+chr(0);var cff="OTTO";var data=this.data;var version=chr(data[0])+chr(data[1])+chr(data[2])+chr(data[3]);var isTTF=(version===ttf);var isCFF=(isTTF?false:version===cff);if(isTTF){this.format="truetype";}
else if(isCFF){this.format="opentype";}
else{error("Error: file at "+this.url+" cannot be interpreted as OpenType font.");return;}
var numTables=ushort(data[4],data[5]),tagStart=12,ptr,end=tagStart+16*numTables,tags={},tag;for(ptr=tagStart;ptr<end;ptr+=16){tag=chr(data[ptr])+chr(data[ptr+1])+chr(data[ptr+2])+chr(data[ptr+3]);tags[tag]={name:tag,checksum:ulong(data[ptr+4],data[ptr+5],data[ptr+6],data[ptr+7]),offset:ulong(data[ptr+8],data[ptr+9],data[ptr+10],data[ptr+11]),length:ulong(data[ptr+12],data[ptr+13],data[ptr+14],data[ptr+15])};}
var checkTableError=function(tag){if(!tags[tag]){error("Error: font is missing the required OpenType '"+tag+"' table.");return false;}
return tag;};tag=checkTableError("head");if(tag===false){return;}
ptr=tags[tag].offset;tags[tag].version=""+data[ptr]+data[ptr+1]+data[ptr+2]+data[ptr+3];var unitsPerEm=ushort(data[ptr+18],data[ptr+19]);this.metrics.quadsize=unitsPerEm;tag=checkTableError("hhea");if(tag===false){return;}
ptr=tags[tag].offset;tags[tag].version=""+data[ptr]+data[ptr+1]+data[ptr+2]+data[ptr+3];this.metrics.ascent=fword(data[ptr+4],data[ptr+5])/unitsPerEm;this.metrics.descent=fword(data[ptr+6],data[ptr+7])/unitsPerEm;this.metrics.leading=fword(data[ptr+8],data[ptr+9])/unitsPerEm;tag=checkTableError("OS/2");if(tag===false){return;}
ptr=tags[tag].offset;tags[tag].version=""+data[ptr]+data[ptr+1];this.metrics.weightclass=ushort(data[ptr+4],data[ptr+5]);tag=checkTableError("cmap");if(tag===false){return;}
ptr=tags[tag].offset;tags[tag].version=""+data[ptr]+data[ptr+1];numTables=ushort(data[ptr+2],data[ptr+3]);var encodingRecord,rptr,platformID,encodingID,offset,cmap314=false;for(var encodingRecord=0;encodingRecord<numTables;encodingRecord++){rptr=ptr+4+encodingRecord*8;platformID=ushort(data[rptr],data[rptr+1]);encodingID=ushort(data[rptr+2],data[rptr+3]);offset=ulong(data[rptr+4],data[rptr+5],data[rptr+6],data[rptr+7]);if(platformID===3&&encodingID===1){cmap314=offset;}}
var printChar="A";if(cmap314!==false){ptr+=cmap314;version=ushort(data[ptr],data[ptr+1]);if(version===4){var segCount=ushort(data[ptr+6],data[ptr+7])/2;var printable=function(chr){return[0x0009,0x000A,0x000B,0x000C,0x000D,0x0020,0x007F,0x0080,0x0081,0x008D,0x008E,0x008F,0x0090,0x0095,0x009D,0x009E,0x00A0,0x2000,0x2001,0x2002,0x2003,0x2004,0x2005,0x2006,0x2007,0x2008,0x2009,0x200A,0x200B,0x200C,0x200D,0x200E,0x200F,0x2028,0x2029,0x202A,0x202B,0x202B,0x202C,0x202D,0x202E,0x202F,0x205F,0x2060,0x2061,0x2062,0x2063,0x2064,0x3000].indexOf(chr)===-1;}
var i=ptr+14,e=ptr+14+2*segCount,endChar=false;for(;i<e;i+=2){endChar=ushort(data[i],data[i+1]);if(printable(endChar)){break;}
endChar=false;}
if(endChar!=false){printChar=String.fromCharCode(endChar);var delta=(-(endChar-1)+65536)%65536;var newcode=chr(0)+
chr16(endChar)+chr16(0xFFFF)+
chr16(0)+
chr16(endChar)+chr16(0xFFFF)+
chr16(delta)+
chr16(1);var newhex=btoa(newcode);this.base64=this.base64.substring(0,380)+newhex+
this.base64.substring(380+newhex.length);}}}
this.bootstrapValidation(printChar,false);}
Font.prototype.bootstrapValidation=function(printChar,timeout){var tfName=this.fontFamily+" testfont";var zerowidth=document.createElement("style");zerowidth.setAttribute("type","text/css");zerowidth.innerHTML="@font-face {\n"+"  font-family: '"+tfName+"';\n"+"  src: url('data:application/x-font-ttf;base64,"+this.base64+"')\n"+"       format('truetype');}";document.head.appendChild(zerowidth);var realfont=false;if(!this.systemfont){realfont=this.toStyleNode();document.head.appendChild(realfont);}
var para=document.createElement("p");para.style.cssText="position: absolute; top: 0; left: 0; opacity: 0;";para.style.fontFamily="'"+this.fontFamily+"', '"+tfName+"'";para.innerHTML=printChar+printChar+printChar+printChar+printChar+
printChar+printChar+printChar+printChar+printChar;document.body.appendChild(para);if(typeof getComputedStyle==="undefined"){this.onload();error("Error: getComputedStyle is not supported by this browser.\n"+"Consequently, Font.onload() cannot be trusted.");}
else{var quad=this.systemfont?1000:this.metrics.quadsize;var canvas=document.createElement("canvas");canvas.width=quad;canvas.height=quad;this.canvas=canvas;var context=canvas.getContext("2d");context.font="1em '"+this.fontFamily+"'";context.fillStyle="white";context.fillRect(-1,-1,quad+2,quad+2);context.fillStyle="black";context.fillText("test text",50,quad/2);this.context=context;var local=this;var delayedValidate=function(){local.validate(para,zerowidth,realfont,local,timeout);};setTimeout(delayedValidate,50);}};Font.prototype.processSystemFont=function(){this.systemfont=true;this.metrics=false;this.bootstrapValidation("A",1000);}
Font.prototype.loadFont=function(){var font=this;if(this.url.indexOf(".")===-1){setTimeout(function(){font.processSystemFont();},10);return;}
var xhr=new XMLHttpRequest();xhr.open('GET',font.url,true);xhr.responseType="arraybuffer";xhr.onload=function(evt){var arrayBuffer=xhr.response;if(arrayBuffer){font.data=new Uint8Array(arrayBuffer);font.ondownloaded();}else{font.onerror("Error downloading font resource from "+font.url);}};xhr.onerror=function(evt){font.onerror("Error downloading font resource from "+font.url);};xhr.send(null);};Font.prototype.styleNode=false;Font.prototype.toStyleNode=function(){if(this.styleNode){return this.styleNode;}
this.styleNode=document.createElement("style");this.styleNode.type="text/css";var styletext="@font-face {\n";styletext+="  font-family: '"+this.fontFamily+"';\n";styletext+="  src: url('"+this.url+"') format('"+this.format+"');\n";styletext+="}";this.styleNode.innerHTML=styletext;return this.styleNode;}
Font.prototype.measureText=function(textString,fontSize){if(!this.loaded){this.onerror("measureText() was called while the font was not yet loaded");return false;}
this.context.font=fontSize+"px '"+this.fontFamily+"'";var metrics=this.context.measureText(textString);metrics.fontsize=fontSize;metrics.ascent=0;metrics.descent=0;metrics.bounds={minx:0,maxx:metrics.width,miny:0,maxy:0};metrics.height=0;var segments=[],minSegments=metrics.width/this.metrics.quadsize;if(minSegments<=1){segments.push(textString);}
else{segments.push(textString);}
var segmentLength=segments.length,i;for(i=0;i<segmentLength;i++){this.measureSegment(segments[i],fontSize,metrics);}
return metrics;};Font.prototype.measureSegment=function(textSegment,fontSize,metrics){var getCSSValue=function(element,property){return document.defaultView.getComputedStyle(element,null).getPropertyValue(property);};var i;var leadDiv=document.createElement("div");leadDiv.style.position="absolute";leadDiv.style.opacity=0;leadDiv.style.font=fontSize+"px '"+this.fontFamily+"'";var numLines=10;leadDiv.innerHTML=textSegment;for(i=1;i<numLines;i++){leadDiv.innerHTML+="<br/>"+textSegment;}
document.body.appendChild(leadDiv);metrics.leading=1.2*fontSize;var leadDivHeight=getCSSValue(leadDiv,"height");leadDivHeight=leadDivHeight.replace("px","");if(leadDivHeight>=fontSize*numLines){metrics.leading=(leadDivHeight/numLines)|0;}
document.body.removeChild(leadDiv);if(/^\s*$/.test(textSegment)){return metrics;}
var canvas=this.canvas,ctx=this.context,quad=this.systemfont?1000:this.metrics.quadsize,w=quad,h=quad,baseline=quad/2,padding=50,xpos=(quad-metrics.width)/2;if(xpos!==(xpos|0)){xpos=xpos|0;}
ctx.fillStyle="white";ctx.fillRect(-padding,-padding,w+2*padding,h+2*padding);ctx.fillStyle="black";ctx.fillText(textSegment,xpos,baseline);var scanwidth=(metrics.width+padding)|0,scanheight=4*fontSize,x_offset=xpos-padding/2,y_offset=baseline-scanheight/2,pixelData=ctx.getImageData(x_offset,y_offset,scanwidth,scanheight).data;var i=0,j=0,w4=scanwidth*4,len=pixelData.length,mid=scanheight/2;while(++i<len&&pixelData[i]===255){}
var ascent=(i/w4)|0;i=len-1;while(--i>0&&pixelData[i]===255){}
var descent=(i/w4)|0;for(i=0,j=0;j<scanwidth&&pixelData[i]===255;){i+=w4;if(i>=len){j++;i=(i-len)+4;}}
var minx=j;var step=1;for(i=len-3,j=0;j<scanwidth&&pixelData[i]===255;){i-=w4;if(i<0){j++;i=(len-3)-(step++)*4;}}
var maxx=scanwidth-j;metrics.ascent=(mid-ascent);metrics.descent=(descent-mid);metrics.bounds={minx:minx-(padding/2),maxx:maxx-(padding/2),miny:-metrics.descent,maxy:metrics.ascent};metrics.height=1+(descent-ascent);return metrics;};Object.defineProperty(Font.prototype,"src",{set:function(url){this.url=url;this.loadFont();}});if(typeof define!=="undefined"){define(function(){return Font;});}else{window.Font=Font;}}(window));